#!/bin/bash -e

# this function comes from wwwconfig-common's apache.func script
getwwwoption() {
    getwwwoption=""
    if [ -f $2 ] ; then
	if grep $1 $2 | grep -v "#" > /dev/null 2>&1 ; then
	    getwwwoption=$(sed -ne "/^[[:space:]]*$1[[:space:]]\+/ s|[[:space:]]*$1[[:space:]]\+\([^[:space:]]\+\)[[:space:]]*$|\1|pg;" < $2)
	fi
    fi
}


# Use debconf baby
. /usr/share/debconf/confmodule
db_version 2.0
db_title Diogenes

db_input "low" "diogenes/welcome" || true
db_go
db_input "high" "diogenes/purge_removes_data" || true
db_go

### Required options no matter what ###
db_input "high" "diogenes/webservers" || true
db_go
db_get "diogenes/webservers"
webservers="$RET"

# if a single webserver is selected, 
# try to get the user and group the webserver runs as
nbsrv=0
for i in $webservers ; do nbsrv=`expr $nbsrv + 1`; done

if [ $nbsrv == 1 ]; then
    server=$(echo $webservers | sed 's/,$//')
    if [ -f /etc/$server/httpd.conf ]; then
        getwwwoption User /etc/$server/httpd.conf
        webuser=$(echo "$getwwwoption" | sed -e "q")
        getwwwoption Group /etc/$server/httpd.conf
        webgroup=$(echo "$getwwwoption" | sed -e "q")
    fi
fi

if [ -z "$webuser" ]; then
    db_input "high" "diogenes/webuser" || true
    db_go
else
    db_set "diogenes/webuser" "$webuser"
fi
if [ -z "$webgroup" ]; then
    db_input "high" "diogenes/webgroup" || true
    db_go
else
    db_set "diogenes/webgroup" "$webgroup"
fi

# source dbconfig-common shell library, and call the hook function
if [ -f /usr/share/dbconfig-common/dpkg/config.mysql ]; then
    . /usr/share/dbconfig-common/dpkg/config.mysql 
    dbc_go diogenes $@
fi


